include:
  - component: "gitlab.gnome.org/GNOME/citemplates/release-service@master"
    inputs:
      job-stage: release
      dist-job-name: release-tarball

image: ubuntu:noble

stages:
  - build
  - release

variables:
  UBUNTU_DEPS:
    build-essential
    desktop-file-utils
    gettext
    pkg-config
    libgtk-3-dev
    libgtk-4-bin
    libgstreamer1.0-dev
    libgstreamer-plugins-base1.0-dev
    libgdk-pixbuf2.0-dev
    libglib2.0-dev
    libgpod-dev
    libtotem-plparser-dev
    libsoup-3.0-dev
    libgudev-1.0-dev
    libmtp-dev
    libnotify-dev
    libbrasero-media3-dev
    libsecret-1-dev
    libpeas-dev
    yelp-tools
    x11proto-core-dev
    liblirc-dev
    python3-dev
    python-gi-dev
    libjson-glib-dev
    libgrilo-0.3-dev
    libxml2-dev
    libtdb-dev
    python3-pip
    ninja-build
    check
    valac
    xvfb

  MESON_ARGS:
    -Dprefix=/usr
    -Dfm_radio=disabled
    -Dplugins_python=enabled
    -Dlibnotify=enabled
    -Dgrilo=enabled
    -Dgudev=enabled
    -Dipod=enabled
    -Dlibsecret=enabled
    -Dmtp=enabled
    -Dlirc=enabled
    -Dsample-plugins=true
    -Dapidoc=true
    -Dhelp=true
    -Dtests=enabled


build:
  stage: build
  variables:
    MESON_BUILD_DIR: "_build"
  before_script:
    - export DEBIAN_FRONTEND=noninteractive
    - apt-get update
    - apt-get install -y $UBUNTU_DEPS
    - pip3 install --break-system-packages meson gi-docgen
  script:
    - meson setup ${MESON_BUILD_DIR} ${MESON_ARGS}
    - cd ${MESON_BUILD_DIR}
    - ninja
    - G_MESSAGES_DEBUG=all xvfb-run -a -s "-screen 0 1024x768x24 -noreset" meson test
    - ninja install
  artifacts:
    when: always
    name: "rhythmbox-${CI_COMMIT_REF_NAME}"
    paths:
      - "${CI_PROJECT_DIR}/_build/meson-logs"
      - "${MESON_BUILD_DIR}/doc"

release-tarball:
  stage: build
  rules:
    - if: $CI_COMMIT_TAG || $CI_COMMIT_BRANCH == "prerelease"
  variables:
    MESON_BUILD_DIR: "_build"
  before_script:
    - export DEBIAN_FRONTEND=noninteractive
    - apt-get update
    - apt-get install -y $UBUNTU_DEPS git
    - pip3 install --break-system-packages meson gi-docgen
  script:
    - meson setup ${MESON_BUILD_DIR} ${MESON_ARGS}
    - cd ${MESON_BUILD_DIR}
    - xvfb-run -a -s "-screen 0 1024x768x24 -noreset" meson dist
    - cp -r meson-dist/ "${CI_PROJECT_DIR}/public-dist/"
  artifacts:
    name: "${CI_JOB_NAME}-${CI_COMMIT_REF_NAME}"
    when: always
    paths:
      - "public-dist"
